<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiblioGenius - Settings</title>
    <link rel="stylesheet" href="/css/app.css?v=beige">
</head>

<body>
    <div class="container">
        <header>
            <h1>üìö BiblioGenius - Settings</h1>
            <nav>
                <a href="/" data-i18n="nav.dashboard">Dashboard</a>
                <a href="/books.html" data-i18n="nav.books">Books</a>
                <a href="/copies.html" data-i18n="nav.copies">Copies</a>
                <a href="/contacts.html" data-i18n="nav.contacts">Contacts</a>
                <a href="/loans.html" data-i18n="nav.loans">Loans</a>
                <a href="/p2p.html" data-i18n="nav.p2p">P2P Search</a>
                <a href="/settings.html" class="active" data-i18n="nav.settings">Settings</a>
            </nav>
        </header>

        <div class="card" style="display: block !important; visibility: visible !important; opacity: 1 !important;">
            <h2 data-i18n="settings.language" style="display: block !important;">üåç Language</h2>
            <p style="color: var(--text-muted); margin-bottom: 1rem;" data-i18n="settings.selectLanguage">
                Select your preferred language
            </p>
            <div class="form-group" style="display: block !important;">
                <select id="languageSelect" onchange="changeLanguage(this.value)"
                    style="max-width: 300px; display: block !important; width: 100%;">
                    <option value="en">English</option>
                    <option value="fr">Fran√ßais</option>
                    <option value="es">Espa√±ol</option>
                    <option value="de">Deutsch</option>
                </select>
            </div>
        </div>

        <div class="card">
            <h2 data-i18n="settings.import.title">üì• Import Library</h2>
            <p style="color: var(--text-light); margin-bottom: 1rem;" data-i18n="settings.import.description">
                Migrate your library from other platforms. Currently supports <strong>Goodreads CSV export</strong>.
            </p>

            <div
                style="background: #f8fafc; padding: 1.5rem; border-radius: 8px; border: 2px dashed #cbd5e1; text-align: center;">
                <input type="file" id="importFile" accept=".csv" style="display: none;">
                <label for="importFile" class="btn btn-primary" style="cursor: pointer;"
                    data-i18n="settings.import.selectFile">Select CSV File</label>
                <div id="fileName" style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-light);"></div>
                <button id="importBtn" class="btn btn-success" style="margin-top: 1rem; display: none;"
                    onclick="importLibrary()" data-i18n="settings.import.start">Start Import</button>
            </div>
            <div id="importStatus" style="margin-top: 1rem;"></div>
        </div>

        <div class="card">
            <h2 data-i18n="settings.export.title">üì§ Export Backup</h2>
            <p style="color: var(--text-light); margin-bottom: 1rem;" data-i18n="settings.export.description">
                Download a full backup of your library (Books, Copies, Contacts, Loans) in JSON format.
            </p>
            <button class="btn btn-primary" onclick="exportLibrary()" data-i18n="settings.export.download">Download
                JSON Backup</button>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/theme.js"></script>
    <script src="/js/i18n.js?v=2"></script>
    <script>
        // Initialize i18n
        document.addEventListener('DOMContentLoaded', async () => {
            await i18n.load(localStorage.getItem('lang') || 'en');
            i18n.applyTranslations();
            document.getElementById('languageSelect').value = i18n.currentLang;
        });

        async function changeLanguage(lang) {
            await i18n.setLanguage(lang);
            // Reload to ensure all dynamic content (like nav) is updated if needed, 
            // though applyTranslations does a lot. For simplicity, reload.
            location.reload();
        }

        const fileInput = document.getElementById('importFile');
        const fileNameDiv = document.getElementById('fileName');
        const importBtn = document.getElementById('importBtn');
        const statusDiv = document.getElementById('importStatus');

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                fileNameDiv.textContent = `Selected: ${e.target.files[0].name}`;
                importBtn.style.display = 'inline-block';
            } else {
                fileNameDiv.textContent = '';
                importBtn.style.display = 'none';
            }
        });

        async function importLibrary() {
            const file = fileInput.files[0];
            if (!file) return;

            statusDiv.innerHTML = '<div class="loading">Importing... This may take a moment.</div>';
            importBtn.disabled = true;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/import/goodreads', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    statusDiv.innerHTML = `
                        <div style="padding: 1rem; background: #d1fae5; border-radius: 8px; color: #065f46;">
                            ‚úÖ Successfully imported <strong>${result.imported}</strong> books!
                        </div>
                    `;
                    fileInput.value = '';
                    fileNameDiv.textContent = '';
                    importBtn.style.display = 'none';
                    importBtn.disabled = false;
                } else {
                    throw new Error(result.error || 'Import failed');
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div style="padding: 1rem; background: #fee2e2; border-radius: 8px; color: #991b1b;">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
                importBtn.disabled = false;
            }
        }

        function exportLibrary() {
            window.location.href = '/api/export/json';
        }
    </script>
</body>

</html>