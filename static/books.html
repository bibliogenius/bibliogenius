<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiblioGenius - Books</title>
    <link rel="stylesheet" href="/css/app.css?v=beige">
    <style>
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1;
            border-radius: 4px;
        }

        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        .dropdown-content a:hover {
            background-color: #f1f1f1;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1 data-i18n="books.title">üìö Books</h1>
            <nav>
                <a href="/" data-i18n="nav.dashboard">Dashboard</a>
                <a href="/books.html" class="active" data-i18n="nav.books">Books</a>
                <a href="/copies.html" data-i18n="nav.copies">Copies</a>
                <a href="/contacts.html" data-i18n="nav.contacts">Contacts</a>
                <a href="/loans.html" data-i18n="nav.loans">Loans</a>
                <a href="/p2p.html" data-i18n="nav.p2p">P2P Search</a>
                <a href="/settings.html" data-i18n="nav.settings">Settings</a>
            </nav>
        </header>

        <div class="card">
            <div class="toolbar">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search books..." onkeyup="filterBooks()">
                    <button class="btn btn-sm btn-secondary" onclick="toggleAdvancedSearch()"
                        style="margin-left: 0.5rem;">‚öôÔ∏è
                        Filters</button>
                </div>
                <div class="actions">
                    <button class="btn btn-primary" onclick="toggleSelectionMode()" id="selectModeBtn">Select
                        Books</button>
                    <a href="/add_book.html" class="btn btn-primary">Add Book</a>
                </div>
            </div>

            <!-- Advanced Search Sidebar -->
            <div id="advancedSearchSidebar" class="sidebar">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h3>Advanced Search</h3>
                    <button class="btn btn-sm btn-secondary" onclick="toggleAdvancedSearch()">‚úï</button>
                </div>
                <form id="advancedSearchForm" onsubmit="handleAdvancedSearch(event)">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" name="title" placeholder="Book title">
                    </div>
                    <div class="form-group">
                        <label>Author</label>
                        <input type="text" name="author" placeholder="Author name">
                    </div>
                    <div class="form-group">
                        <label>Publisher</label>
                        <input type="text" name="publisher" placeholder="Publisher">
                    </div>
                    <div class="form-group" style="display: flex; gap: 1rem;">
                        <div style="flex: 1;">
                            <label>Year From</label>
                            <input type="number" name="year_min" placeholder="1900">
                        </div>
                        <div style="flex: 1;">
                            <label>Year To</label>
                            <input type="number" name="year_max" placeholder="2025">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Tags</label>
                        <input type="text" name="tags" placeholder="sci-fi, history">
                        <small style="color: #666;">Comma separated</small>
                    </div>
                    <div class="form-group">
                        <label>Search In</label>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal;">
                                <input type="checkbox" name="source_local" value="local" checked style="width: auto;">
                                My
                                Library
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal;">
                                <input type="checkbox" name="source_peers" value="peers" style="width: auto;"> Friends
                                (P2P)
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal;">
                                <input type="checkbox" name="source_public" value="public" style="width: auto;"> Public
                                Libraries
                            </label>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Search</button>
                        <button type="button" class="btn btn-secondary" onclick="resetAdvancedSearch()"
                            style="flex: 1;">Reset</button>
                    </div>
                </form>
            </div>
            <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleAdvancedSearch()"></div>

            <div id="booksList" style="margin-top: 2rem;">
                <div class="loading">Loading books...</div>
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/theme.js"></script>
    <script>
        let isProfessional = false;

        async function checkProfile() {
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    const config = await response.json();
                    isProfessional = config.profile_type === 'professional';
                    if (isProfessional) {
                        document.getElementById('proFields').style.display = 'block';
                        document.getElementById('lookupSource').style.display = 'block'; // Show source selector
                    }
                }
            } catch (e) {
                console.error("Failed to load profile config", e);
            }
        }

        function showAddForm() {
            document.getElementById('addForm').style.display = 'block';
            document.getElementById('lookupIsbn').focus();
        }

        function hideAddForm() {
            document.getElementById('addForm').style.display = 'none';
            document.getElementById('bookForm').reset();
            document.getElementById('lookupIsbn').value = '';
            document.getElementById('lookupStatus').innerHTML = '';
            document.getElementById('coverPreview').style.display = 'none';
        }

        async function lookupBook() {
            const isbnInput = document.getElementById('lookupIsbn');
            const statusDiv = document.getElementById('lookupStatus');
            const sourceSelect = document.getElementById('lookupSource');
            const source = sourceSelect.value;
            const isbn = isbnInput.value.trim().replace(/-/g, '');

            if (!isbn) {
                statusDiv.innerHTML = '<span style="color: var(--danger);">Please enter an ISBN</span>';
                return;
            }

            statusDiv.innerHTML = `<span style="color: var(--primary);">Searching ${source === 'sudoc' ? 'SUDOC' : 'Open Library'}...</span>`;
            isbnInput.disabled = true;

            try {
                let response;

                if (source === 'sudoc') {
                    const res = await fetch(`/api/integrations/sudoc/search?isbn=${isbn}`);
                    const data = await res.json();
                    if (!data.success) throw new Error(data.error || 'Not found in SUDOC');
                    response = data.book;
                } else {
                    // Open Library
                    response = await api.request(`/lookup/${isbn}`);
                }

                // Auto-fill form
                document.getElementById('title').value = response.title || '';
                document.getElementById('isbn').value = isbn;
                document.getElementById('publisher').value = response.publisher || '';
                document.getElementById('year').value = response.publication_year || '';

                // Auto-fill professional fields
                if (isProfessional) {
                    if (response.dewey) document.getElementById('dewey').value = response.dewey;
                    if (response.subjects && Array.isArray(response.subjects)) {
                        document.getElementById('subjects').value = response.subjects.join(', ');
                    }
                    // Store raw data if available
                    if (response.raw_data) {
                        document.getElementById('sourceData').value = response.raw_data;
                    }
                }

                // Show cover if available (SUDOC doesn't provide covers usually, but Open Library does)
                if (response.cover_url) {
                    const coverImg = document.getElementById('coverImage');
                    coverImg.src = response.cover_url;
                    document.getElementById('coverPreview').style.display = 'block';
                } else {
                    document.getElementById('coverPreview').style.display = 'none';
                }

                statusDiv.innerHTML = '<span style="color: var(--success);">‚úÖ Found! Details auto-filled.</span>';
            } catch (error) {
                console.error(error);
                statusDiv.innerHTML = `<span style="color: var(--danger);">‚ùå Book not found or error: ${error.message}</span>`;
            } finally {
                isbnInput.disabled = false;
            }
        }

        // Allow Enter key to trigger lookup
        document.getElementById('lookupIsbn').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent form submission if inside form
                lookupBook();
            }
        });

        async function loadBooks() {
            const listDiv = document.getElementById('booksList');
            try {
                const data = await api.getBooks();
                const books = data.books || [];

                if (books.length === 0) {
                    listDiv.innerHTML = '<p style="color: var(--text-light);">No books yet. Add your first book!</p>';
                    return;
                }

                let html = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <button class="btn btn-sm" onclick="toggleSelectionMode()">
                            ${isSelectionMode ? 'Cancel Selection' : 'Select Books'}
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-sm">Sort By ‚ñº</button>
                            <div class="dropdown-content">
                                <a href="#" onclick="batchSort('Title')">Title</a>
                                <a href="#" onclick="batchSort('Author')">Author</a>
                                <a href="#" onclick="batchSort('Year')">Year</a>
                            </div>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                ${isSelectionMode ? '<th><input type="checkbox" disabled></th>' : ''}
                                <th>Title</th>
                                <th>ISBN</th>
                                <th>Publisher</th>
                                <th>Year</th>
                                <th>Source</th>
                                ${isProfessional ? '<th>Call Number</th>' : ''}
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                html += books.map(book => `
                    <tr>
                        ${isSelectionMode ? `<td><input type="checkbox" onchange="toggleBookSelection(${book.id})" ${selectedBooks.has(book.id) ? 'checked' : ''}></td>` : ''}
                        <td><strong>${book.title}</strong></td>
                        <td>${book.isbn || '-'}</td>
                        <td>${book.publisher || '-'}</td>
                        <td>${book.publication_year || '-'}</td>
                        ${isProfessional ? `<td>${book.dewey_decimal || book.lcc || '-'}</td>` : ''}
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteBook(${book.id})">Delete</button>
                        </td>
                    </tr>
                `).join('');

                html += `</tbody></table>`;
                listDiv.innerHTML = html;

            } catch (error) {
                listDiv.innerHTML = `<p style="color: var(--danger);">Error loading books: ${error.message}</p>`;
            }
        }

        document.getElementById('bookForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const bookData = {
                title: document.getElementById('title').value,
                isbn: document.getElementById('isbn').value || null,
                publisher: document.getElementById('publisher').value || null,
                publication_year: parseInt(document.getElementById('year').value) || null
            };

            if (isProfessional) {
                bookData.dewey_decimal = document.getElementById('dewey').value || null;
                bookData.lcc = document.getElementById('lcc').value || null;
                bookData.cataloguing_notes = document.getElementById('notes').value || null;
                bookData.source_data = document.getElementById('sourceData').value || null;

                const subjectsStr = document.getElementById('subjects').value;
                if (subjectsStr) {
                    bookData.subjects = subjectsStr.split(',').map(s => s.trim()).filter(s => s.length > 0);
                }
            }

            try {
                await api.createBook(bookData);
                hideAddForm();
                loadBooks();
            } catch (error) {
                alert('Error creating book: ' + error.message);
            }
        });

        async function deleteBook(id) {
            if (!confirm('Delete this book?')) return;
            try {
                await api.deleteBook(id);
                loadBooks();
            } catch (error) {
                alert('Error deleting book: ' + error.message);
            }
        }

        function toggleAdvancedSearch() {
            const sidebar = document.getElementById('advancedSearchSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('visible');
        }

        async function handleAdvancedSearch(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const params = new URLSearchParams();

            // Handle sources
            const sources = [];
            if (formData.get('source_local')) sources.push('local');
            if (formData.get('source_peers')) sources.push('peers');
            if (formData.get('source_public')) sources.push('public');
            if (sources.length > 0) params.append('sources', sources.join(','));

            for (const [key, value] of formData.entries()) {
                if (key.startsWith('source_')) continue; // Skip individual checkboxes
                if (value.trim()) {
                    params.append(key, value.trim());
                }
            }

            try {
                const res = await fetch(`/api/books/search?${params.toString()}`);
                const data = await res.json();

                // Update table
                const tbody = document.querySelector('tbody');
                tbody.innerHTML = '';

                if (data.books.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No books found matching your filters.</td></tr>';
                } else {
                    data.books.forEach(book => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>
                                <input type="checkbox" class="book-checkbox" value="${book.id}" onchange="toggleBookSelection(${book.id})" style="display: ${isSelectionMode ? 'inline-block' : 'none'}">
                            </td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <img src="${book.cover_url || '/images/placeholder_cover.jpg'}" alt="Cover" style="width: 40px; height: 60px; object-fit: cover; border-radius: 4px;">
                                    <div>
                                        <div style="font-weight: 500;">${book.title}</div>
                                        <div style="font-size: 0.85rem; color: #666;">${book.isbn || 'No ISBN'}</div>
                                    </div>
                                </div>
                            </td>
                            <td>${book.author || 'Unknown'}</td> <!-- Note: Author might be missing in search result if not joined -->
                            <td>${book.publisher || '-'}</td>
                            <td>${book.publication_year || '-'}</td>
                            <td>
                                ${book.source === 'Local' || !book.source
                                ? '<span class="badge badge-primary">Local</span>'
                                : `<span class="badge badge-secondary">${book.source}</span>`}
                            </td>
                            <td>
                                <div class="actions">
                                    ${book.source === 'Local' || !book.source
                                ? `<button class="btn-icon" onclick="editBook(${book.id})">‚úèÔ∏è</button>
                                           <button class="btn-icon delete" onclick="deleteBook(${book.id})">üóëÔ∏è</button>`
                                : book.source.startsWith('Peer')
                                    ? `<button class="btn-icon" onclick="requestBook('${book.source_data}', '${book.isbn}', '${book.title}')">üëã Request</button>`
                                    : `<button class="btn-icon" onclick="importBook('${book.isbn}', '${book.title}')">‚¨áÔ∏è Import</button>`
                            }
                                </div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }

                // Close sidebar
                toggleAdvancedSearch();

                // Show active filter indicator (optional)
                document.getElementById('searchInput').placeholder = `Filtered: ${data.total} results`;

            } catch (err) {
                console.error(err);
                alert('Search failed');
            }
        }

        function resetAdvancedSearch() {
            document.getElementById('advancedSearchForm').reset();
            loadBooks(); // Reload all
            document.getElementById('searchInput').placeholder = "Search books...";
        }

        // Initialize
        checkProfile().then(() => loadBooks());

        // Batch Operations Logic
        let selectedBooks = new Set();
        let isSelectionMode = false;

        function toggleSelectionMode() {
            isSelectionMode = !isSelectionMode;
            selectedBooks.clear();
            updateBatchToolbar();
            loadBooks(); // Re-render to show/hide checkboxes
        }

        function toggleBookSelection(id) {
            if (selectedBooks.has(id)) {
                selectedBooks.delete(id);
            } else {
                selectedBooks.add(id);
            }
            updateBatchToolbar();
        }

        function updateBatchToolbar() {
            const toolbar = document.getElementById('batchToolbar');
            const countSpan = document.getElementById('selectedCount');

            if (selectedBooks.size > 0) {
                toolbar.classList.add('visible');
                countSpan.textContent = `${selectedBooks.size} selected`;
            } else {
                toolbar.classList.remove('visible');
            }
        }

        async function batchDelete() {
            if (!confirm(`Delete ${selectedBooks.size} books? This cannot be undone.`)) return;

            try {
                const res = await fetch('/api/books/batch/edit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ids: Array.from(selectedBooks),
                        action: { type: 'Delete' }
                    })
                });

                if (res.ok) {
                    selectedBooks.clear();
                    updateBatchToolbar();
                    loadBooks();
                } else {
                    alert('Batch delete failed');
                }
            } catch (e) {
                console.error(e);
                alert('Error: ' + e.message);
            }
        }

        async function requestBook(sourceData, isbn, title) {
            if (!confirm(`Request "${title}" from this peer?`)) return;

            try {
                const data = JSON.parse(sourceData);
                if (!data.peer_id) throw new Error("Invalid peer data");

                await api.requestBook(data.peer_id, isbn, title);
                alert('Request sent! Check the Requests page for status.');
            } catch (e) {
                console.error(e);
                alert('Failed to send request: ' + e.message);
            }
        }

        async function batchSort(criteria) {
            try {
                const res = await fetch('/api/books/batch/sort', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sort_by: criteria })
                });

                if (res.ok) {
                    loadBooks();
                } else {
                    alert('Sort failed');
                }
            } catch (e) {
                console.error(e);
            }
        }
    </script>

    <!-- Batch Toolbar -->
    <div id="batchToolbar" class="batch-toolbar">
        <span id="selectedCount" style="font-weight: bold;">0 selected</span>
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-danger btn-sm" onclick="batchDelete()">üóëÔ∏è Delete</button>
            <!-- <button class="btn btn-sm" onclick="batchTag()">üè∑Ô∏è Tag</button> -->
        </div>
    </div>

    <style>
        .batch-toolbar {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: white;
            padding: 1rem 2rem;
            border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            gap: 2rem;
            align-items: center;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
            border: 1px solid #eee;
        }

        .batch-toolbar.visible {
            transform: translateX(-50%) translateY(0);
        }
    </style>

    <script src="/js/i18n.js?v=2"></script>
    <script>
        // Initialize i18n
        document.addEventListener('DOMContentLoaded', async () => {
            await i18n.load(localStorage.getItem('lang') || 'en');
            i18n.applyTranslations();
        });
    </script>
</body>

</html>