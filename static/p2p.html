<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiblioGenius - P2P Search</title>
    <link rel="stylesheet" href="/css/app.css?v=beige">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>üìö BiblioGenius - P2P Search</h1>
            <nav>
                <a href="/">Dashboard</a>
                <a href="/books.html">Books</a>
                <a href="/copies.html">Copies</a>
                <a href="/contacts.html">Contacts</a>
                <a href="/loans.html">Loans</a>
                <a href="/p2p.html">P2P Search</a>
            </nav>
        </header>

        <div class="card">
            <h2>üåê Connect to Remote Library</h2>

            <!-- Share Your URL Section -->
            <div style="background: #e0f2fe; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h3 style="margin-bottom: 0.5rem; font-size: 1rem;">üì§ Share Your Library URL</h3>
                <p style="margin-bottom: 0.5rem; color: var(--text-light); font-size: 0.9rem;">
                    Give this URL to friends so they can connect to your library:
                </p>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="text" id="myUrl" readonly value="" style="flex: 1; background: white;">
                    <button class="btn btn-primary btn-sm" onclick="copyMyUrl()">Copy</button>
                </div>

                <!-- Warning for localhost -->
                <div id="localhostWarning"
                    style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: #fef3c7; border-radius: 6px; border-left: 4px solid #f59e0b;">
                    <p style="margin: 0; color: #92400e; font-size: 0.9rem; font-weight: 500;">
                        ‚ö†Ô∏è This URL won't work for remote friends!
                    </p>
                    <p style="margin: 0.5rem 0 0 0; color: #92400e; font-size: 0.85rem;">
                        <strong>To share with others:</strong>
                    </p>
                    <ul style="margin: 0.5rem 0 0 1.5rem; color: #92400e; font-size: 0.85rem;">
                        <li><strong>Same network</strong> (home/office): Use your local IP like
                            <code>http://192.168.1.50:8000</code>
                        </li>
                        <li><strong>Over internet</strong>: Use your public IP or domain like
                            <code>https://my-library.com</code>
                        </li>
                    </ul>
                    <details style="margin-top: 0.5rem;">
                        <summary style="cursor: pointer; color: #92400e; font-size: 0.85rem; font-weight: 500;">How to
                            find my IP address?</summary>
                        <p style="margin: 0.5rem 0 0 0; color: #92400e; font-size: 0.8rem;">
                            <strong>On Mac:</strong> System Settings ‚Üí Network ‚Üí Select your connection ‚Üí IP address<br>
                            <strong>On Windows:</strong> Settings ‚Üí Network & Internet ‚Üí Properties ‚Üí IPv4 address<br>
                            <strong>On Linux:</strong> Run <code>ip addr show</code> or <code>ifconfig</code> in
                            terminal
                        </p>
                    </details>
                </div>
            </div>

            <h3 style="margin-bottom: 1rem;">üîó Connect to Friend's Library</h3>
            <form id="connectForm">
                <div class="form-group">
                    <label>Library Name</label>
                    <input type="text" id="peerName" placeholder="e.g., Bob's Library" required>
                    <small style="color: var(--text-light);">A friendly name to identify this library</small>
                </div>
                <div class="form-group">
                    <label>Library URL</label>
                    <input type="text" id="peerUrl" placeholder="http://192.168.1.50:8000 or https://friend.example.com"
                        required>
                    <small style="color: var(--text-light);">
                        Ask your friend for their URL. Examples:<br>
                        ‚Ä¢ Local network: <code>http://192.168.1.50:8000</code><br>
                        ‚Ä¢ Internet: <code>https://library.example.com</code><br>
                        ‚Ä¢ Raspberry Pi: <code>http://raspberrypi.local:8000</code>
                    </small>
                </div>
                <button type="submit" class="btn btn-primary">Connect</button>
            </form>
            <div id="connectResult" style="margin-top: 1rem;"></div>
        </div>

        <div class="card">
            <h2>üåç Discovery Map</h2>
            <p style="color: var(--text-light); margin-bottom: 1rem;">Find BiblioGenius peers near you.</p>

            <div id="map" style="height: 400px; width: 100%; border-radius: 12px; margin-bottom: 1rem;"></div>

            <div class="map-controls" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="layerPeers" checked onchange="updateMapLayers()">
                    <span
                        style="display: inline-block; width: 12px; height: 12px; background: #10b981; border-radius: 50%;"></span>
                    Peers
                </label>
            </div>
        </div>

        <div class="card">
            <h2>üîç Search Remote Library</h2>
            <form id="searchForm">
                <div class="form-group">
                    <label>Peer ID</label>
                    <input type="number" id="peerId" placeholder="1" required>
                    <small style="color: var(--text-light);">Use the ID from the connection above</small>
                </div>
                <div class="form-group">
                    <label>Search Query</label>
                    <input type="text" id="searchQuery" placeholder="Book title..." required>
                </div>
                <button type="submit" class="btn btn-primary">Search</button>
            </form>
        </div>

        <div class="card" id="resultsCard" style="display: none;">
            <h2>Search Results</h2>
            <div id="searchResults"></div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/theme.js"></script>
    <script>
        let map;
        let layers = {
            peers: L.layerGroup(),
            me: L.layerGroup()
        };
        let myLocation = null;
        let myLibraryId = 1; // Default to 1

        // Populate "My URL" field with current location
        window.addEventListener('DOMContentLoaded', async () => {
            const myUrl = `${window.location.protocol}//${window.location.host}`;
            document.getElementById('myUrl').value = myUrl;

            // Show warning if localhost
            if (myUrl.includes('localhost') || myUrl.includes('127.0.0.1')) {
                document.getElementById('localhostWarning').style.display = 'block';
            }

            // Initialize Map
            await initMap();
        });

        async function initMap() {
            // 1. Get My Config (Location)
            try {
                const configRes = await fetch('/api/config');
                const config = await configRes.json();

                if (config.id) {
                    myLibraryId = config.id;
                }

                if (config.latitude && config.longitude) {
                    myLocation = [config.latitude, config.longitude];
                } else {
                    // Default to Paris if no location set
                    myLocation = [48.8566, 2.3522];
                }
            } catch (e) {
                console.error("Failed to load config", e);
                myLocation = [48.8566, 2.3522];
            }

            // 2. Create Map
            map = L.map('map').setView(myLocation, 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // 3. Add "Me" marker
            const meIcon = L.divIcon({
                className: 'custom-div-icon',
                html: "<div style='background-color:#8b5cf6; width:15px; height:15px; border-radius:50%; border:2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.3);'></div>",
                iconSize: [15, 15],
                iconAnchor: [7, 7]
            });
            L.marker(myLocation, { icon: meIcon }).addTo(map).bindPopup("<b>You are here</b>");

            // 4. Load Layers
            await loadPeers();
        }

        async function loadPeers() {
            try {
                const res = await fetch('/api/peers');
                const peers = await res.json();

                layers.peers.clearLayers();
                peers.forEach(peer => {
                    if (peer.latitude && peer.longitude) {
                        const marker = L.marker([peer.latitude, peer.longitude], {
                            icon: createIcon('#10b981') // Green
                        }).bindPopup(`
                            <b>${peer.name}</b><br>BiblioGenius Peer<br>
                            <button class="btn btn-sm btn-primary" style="margin-top: 5px;" onclick="addPeerToContacts('${peer.name.replace(/'/g, "\\'")}', '${peer.url}')">Add to Contacts</button>
                        `);
                        layers.peers.addLayer(marker);
                    }
                });
                layers.peers.addTo(map);
            } catch (e) {
                console.error("Failed to load peers", e);
            }
        }

        async function addPeerToContacts(name, url) {
            try {
                await api.createContact({
                    type: 'library',
                    name: name,
                    notes: `Added from Discovery Map. URL: ${url}`,
                    library_owner_id: myLibraryId || 1
                });
                alert(`Added "${name}" to contacts!`);
            } catch (e) {
                alert(`Failed to add contact: ${e.message}`);
                console.error(e);
            }
        }

        function updateMapLayers() {
            if (document.getElementById('layerPeers').checked) {
                map.addLayer(layers.peers);
            } else {
                map.removeLayer(layers.peers);
            }
        }

        function createIcon(color) {
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div style='background-color:${color}; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.3);'></div>`,
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });
        }

        // Copy My URL to clipboard
        function copyMyUrl() {
            const urlField = document.getElementById('myUrl');
            urlField.select();
            document.execCommand('copy');

            // Show feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úì Copied!';
            setTimeout(() => {
                btn.textContent = originalText;
            }, 2000);
        }

        // Connect to peer
        document.getElementById('connectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const resultDiv = document.getElementById('connectResult');

            try {
                const result = await api.connectPeer({
                    name: document.getElementById('peerName').value,
                    url: document.getElementById('peerUrl').value
                });

                resultDiv.innerHTML = `
                    <div style="padding: 1rem; background: #d1fae5; border-radius: 8px; color: #065f46;">
                        ‚úÖ Connected! Peer ID: <strong>${result.id}</strong>
                    </div>
                `;

                // Auto-fill peer ID in search form
                document.getElementById('peerId').value = result.id;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="padding: 1rem; background: #fee2e2; border-radius: 8px; color: #991b1b;">
                        ‚ùå Connection failed: ${error.message}
                    </div>
                `;
            }
        });

        // Search remote library
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const resultsDiv = document.getElementById('searchResults');
            const resultsCard = document.getElementById('resultsCard');

            resultsDiv.innerHTML = '<div class="loading">Searching...</div>';
            resultsCard.style.display = 'block';

            try {
                const peerId = parseInt(document.getElementById('peerId').value);
                const query = document.getElementById('searchQuery').value;

                const results = await api.searchRemote(peerId, query);

                if (results.length === 0) {
                    resultsDiv.innerHTML = '<p style="color: var(--text-light);">No results found.</p>';
                    return;
                }

                resultsDiv.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>ISBN</th>
                                <th>Publisher</th>
                                <th>Year</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.map(book => `
                                <tr>
                                    <td><strong>${book.title}</strong></td>
                                    <td>${book.isbn || '-'}</td>
                                    <td>${book.publisher || '-'}</td>
                                    <td>${book.publication_year || '-'}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" onclick="requestBook('${peerId}', '${book.isbn}', '${book.title.replace(/'/g, "\\'")}')">Request</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div style="padding: 1rem; background: #fee2e2; border-radius: 8px; color: #991b1b;">
                        ‚ùå Search failed: ${error.message}
                    </div>
                `;
            }
        });

        async function requestBook(peerId, isbn, title) {
            if (!confirm(`Request "${title}" from this library?`)) return;

            try {
                await api.sendRequest(parseInt(peerId), isbn, title);
                alert('Request sent successfully!');
            } catch (e) {
                alert(`Failed to send request: ${e.message}`);
            }
        }
    </script>
</body>

</html>